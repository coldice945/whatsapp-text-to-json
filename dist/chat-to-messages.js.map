{"version":3,"file":"chat-to-messages.js","sources":["../src/chatToMessages.js","../src/scripts/chat-to-messages.js","../src/utils/info.js"],"sourcesContent":["const CURRENT_USER = 'You'\nconst LINE_DATE_END = 22\nconst LINE_TEXT_START = 23\n\nconst mediaLineRegEx = /(image|audio|video|GIF) omitted$/\n\nexport function convertToJSON(chatTextString, includeMediaLines, includeType) {\n  const chatTextArr = chatTextString.split('\\n')\n  const jsonData = []\n\n  for (let i = 0, len = chatTextArr.length; i < len; i ++) {\n    const line = cleanLine(chatTextArr[i])\n\n    // skip line if empty, media omitted message + flag or e2e encryption message\n    if (\n      !line.length\n      || (!includeMediaLines && mediaLineRegEx.test(line))\n      || (i === 0 && line.indexOf('Messages to this group are now secured with end-to-end encryption.') >= 0)\n    ) {\n      continue\n    }\n\n    const date = getDate(line.slice(0, LINE_DATE_END))\n\n    // if no date, treat as additional line\n    if (!date) {\n      jsonData[jsonData.length - 1].message += `\\n${line}`\n    } else {\n      const { user, messageType, message } = getMessageDetails(line.slice(LINE_TEXT_START))\n\n      jsonData.push({\n        date,\n        user,\n        message,\n        ...( includeType ? { type: messageType } : {})\n      })\n    }\n  }\n\n  return { data: jsonData }\n}\n\nfunction cleanLine(line) {\n  // strip chars: 8206 (ltr), 8236\n  const stripChars = [8206, 8236].map(code => String.fromCharCode(code))\n  return line.replace(new RegExp(`(${stripChars.join('|')})`, 'g'), '').trim()\n}\n\nfunction getDate(dateStr) {\n  if (dateStr[0] !== '[') {\n    return null\n  }\n\n  const year = dateStr.slice(7, 11)\n  const month = parseInt(dateStr.slice(4,6)) - 1\n  const date = dateStr.slice(1, 3)\n  const hour = dateStr.slice(13, 15)\n  const min = dateStr.slice(16, 18)\n  const sec = dateStr.slice(19,21)\n\n  return new Date(year, month, date, hour, min, sec).toISOString()\n}\n\nfunction getMessageDetails(messageStr) {\n\n  // encryption message\n  if (/Messages to this group are now secured with end-to-end encryption./.test(messageStr)) {\n    return {\n      user: null,\n      messageType: 'system',\n      message: 'Messages to this group are now secured with end-to-end encryption.'\n    }\n  }\n\n  // standard message\n  let userEndIndex = messageStr.indexOf(':')\n  \n  if (userEndIndex >= 0) {\n    const user = messageStr.slice(0, userEndIndex)\n    return {\n      user,\n      message: getUserMessage(messageStr, user),\n      messageType: 'message'\n    }\n  }\n\n  // system message\n  userEndIndex = messageStr.search(/\\s(left)/)\n  \n  if (userEndIndex >= 0) {\n    return {\n      user: null,\n      message: messageStr,\n      messageType: 'system'\n    }\n  }\n\n  // action message\n  userEndIndex = messageStr.search(/created|added|changed/)\n\n  if (userEndIndex >= 0) {\n    const userStr = messageStr.slice(0, userEndIndex)\n    // TODO: current user to be configurable\n    return {\n      user: userStr === 'You' ? CURRENT_USER : userStr,\n      message: messageStr,\n      messageType: 'action'\n    }\n  }\n\n  // unhandled message type\n  return {\n    user: null,\n    message: messageStr,\n    messageType: null,\n  }\n}\n\nfunction getUserMessage(messageStr, user = '') {\n  return messageStr.slice(user.length + 2)\n}","import { convertToJSON } from '../chatToMessages'\nimport { info } from '../utils/info'\nimport { writeFile, readFileSync } from 'fs'\n\nconst fileName = process.argv[2]\nconst flags = process.argv.slice(2)\nconst includeMediaLines = flags.includes('-m')\nconst includeType = flags.includes('-t')\n\n// default: hide the omitted media lines, don't show the type\n\nif (!fileName) {\n  throw Error('No filename provided.')\n}\n\nlet json\nlet jsonUrl = `${fileName.slice(0, -4)}-messages.json`\n\ntry {\n  const file = readFileSync(fileName, 'utf8')\n  json = convertToJSON(file, includeMediaLines, includeType)\n} catch (err) {\n  throw Error('Error loading file. Make sure the filename is correct and target file exists.')\n}\n\nif (!json) {\n  throw Error('No data returned.')\n}\n\nwriteFile(jsonUrl, JSON.stringify(json), (err) => {\n  if (err) {\n    throw err\n  }\n  \n  info(`written to ${jsonUrl}`)\n})\n","export function info(message, noEllipsis) {\n  console.log(`${message}${noEllipsis ? '' : '...'}`)\n}\n\nexport const timer = {\n  startTimer() {\n    startTime = Date.now()\n  },\n  getTime() {\n    return `Time taken: ${Date.now() - startTime}`\n  }\n}"],"names":["mediaLineRegEx","cleanLine","line","stripChars","map","code","String","fromCharCode","replace","RegExp","join","trim","getDate","dateStr","year","slice","month","parseInt","date","hour","min","sec","Date","toISOString","getMessageDetails","messageStr","test","user","messageType","message","userEndIndex","indexOf","getUserMessage","search","userStr","length","fileName","process","argv","flags","includeMediaLines","includes","includeType","Error","json","jsonUrl","chatTextString","chatTextArr","split","jsonData","i","len","push","type","data","convertToJSON","readFileSync","err","writeFile","JSON","stringify","console","log"],"mappings":"oBAAA,MAIMA,EAAiB,mCAsCvB,SAASC,EAAUC,GAEjB,MAAMC,EAAa,CAAC,KAAM,MAAMC,IAAIC,GAAQC,OAAOC,aAAaF,IAChE,OAAOH,EAAKM,QAAQ,IAAIC,OAAQ,IAAGN,EAAWO,KAAK,QAAS,KAAM,IAAIC,OAGxE,SAASC,EAAQC,GACf,GAAmB,MAAfA,EAAQ,GACV,YAGF,MAAMC,EAAOD,EAAQE,MAAM,EAAG,IACxBC,EAAQC,SAASJ,EAAQE,MAAM,EAAE,IAAM,EACvCG,EAAOL,EAAQE,MAAM,EAAG,GACxBI,EAAON,EAAQE,MAAM,GAAI,IACzBK,EAAMP,EAAQE,MAAM,GAAI,IACxBM,EAAMR,EAAQE,MAAM,GAAG,IAE7B,WAAWO,KAAKR,EAAME,EAAOE,EAAMC,EAAMC,EAAKC,GAAKE,cAGrD,SAASC,EAAkBC,GAGzB,GAAI,qEAAqEC,KAAKD,GAC5E,MAAO,CACLE,KAAM,KACNC,YAAa,SACbC,QAAS,sEAKb,IAAIC,EAAeL,EAAWM,QAAQ,KAEtC,GAAID,GAAgB,EAAG,CACrB,MAAMH,EAAOF,EAAWV,MAAM,EAAGe,GACjC,MAAO,CACLH,KAAAA,EACAE,QAASG,EAAeP,EAAYE,GACpCC,YAAa,WAOjB,GAFAE,EAAeL,EAAWQ,OAAO,YAE7BH,GAAgB,EAClB,MAAO,CACLH,KAAM,KACNE,QAASJ,EACTG,YAAa,UAOjB,GAFAE,EAAeL,EAAWQ,OAAO,yBAE7BH,GAAgB,EAAG,CACrB,MAAMI,EAAUT,EAAWV,MAAM,EAAGe,GAEpC,MAAO,CACLH,KAAkB,QAAZO,EAxGS,MAwG0BA,EACzCL,QAASJ,EACTG,YAAa,UAKjB,MAAO,CACLD,KAAM,KACNE,QAASJ,EACTG,YAAa,MAIjB,SAASI,EAAeP,EAAYE,EAAO,IACzC,OAAOF,EAAWV,MAAMY,EAAKQ,OAAS,GCnHxC,MAAMC,EAAWC,QAAQC,KAAK,GACxBC,EAAQF,QAAQC,KAAKvB,MAAM,GAC3ByB,EAAoBD,EAAME,SAAS,MACnCC,EAAcH,EAAME,SAAS,MAInC,IAAKL,EACH,MAAMO,MAAM,yBAGd,IAAIC,EACAC,EAAaT,EAASrB,MAAM,GAAI,GAArB,iBAEf,IAEE6B,WDd4BE,EAAgBN,EAAmBE,GAC/D,MAAMK,EAAcD,EAAeE,MAAM,MACnCC,EAAW,GAEjB,IAAK,IAAIC,EAAI,EAAGC,EAAMJ,EAAYZ,OAAQe,EAAIC,EAAKD,IAAM,CACvD,MAAMhD,EAAOD,EAAU8C,EAAYG,IAGnC,IACGhD,EAAKiC,SACDK,GAAqBxC,EAAe0B,KAAKxB,IACpC,IAANgD,GAAWhD,EAAK6B,QAAQ,uEAAyE,EAErG,SAGF,MAAMb,EAAON,EAAQV,EAAKa,MAAM,EArBd,KAwBlB,GAAKG,EAEE,CACL,MAAMS,KAAEA,EAAFC,YAAQA,EAARC,QAAqBA,GAAYL,EAAkBtB,EAAKa,MA1B5C,KA4BlBkC,EAASG,KAAK,CACZlC,KAAAA,EACAS,KAAAA,EACAE,QAAAA,KACKa,EAAc,CAAEW,KAAMzB,GAAgB,UAR7CqB,EAASA,EAASd,OAAS,GAAGN,SAAY,KAAI3B,EAalD,MAAO,CAAEoD,KAAML,GCnBRM,CADMC,eAAapB,EAAU,QACTI,EAAmBE,GAC9C,MAAOe,GACP,MAAMd,MAAM,iFAGd,IAAKC,EACH,MAAMD,MAAM,qBAGde,YAAUb,EAASc,KAAKC,UAAUhB,GAAQa,IACxC,GAAIA,EACF,MAAMA,EC9BRI,QAAQC,IDiCF,cAAajB,ECjCN"}